---
import type { User } from '@supabase/supabase-js';

interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  user?: User | null;
}

const {
  title,
  description = "Workspace by Ali â€” Active research and build logs",
  canonicalUrl,
  user = null
} = Astro.props;

const today = new Date();
---
<link rel="stylesheet" href="/styles/global.css" />

<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

    <!-- Accessibility & Theming -->
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#0a0a0a" />

    <!-- Favicons (optional hooks) -->
    <!-- <link rel="icon" href="/favicon.ico" /> -->

    <style is:global>
      :root{
        /* Core palette */
        --bg: #0a0a0a;
        --elev-1: #0f0f0f;
        --elev-2: #131313;
        --elev-3: #161616;

        --border-1:#202020;
        --border-2:#252525;
        --border-3:#353535;

        --text-1:#ffffff;
        --text-2:#e0e0e0;
        --text-3:#bbbbbb;
        --text-4:#888888;
        --text-5:#666666;
        --muted:#555555;

        --brand:#4a9eff;
        --brand-2:#6bb0ff;
        --ok:#22c55e;
        --warn:#f59e0b;
        --err:#ef4444;

        --radius-sm:6px;
        --radius-md:12px;

        --shadow-1: 0 2px 16px rgba(0,0,0,.25);
        --container: 1200px;

        --focus: 0 0 0 3px rgba(74,158,255,.45);
      }

      *{ box-sizing:border-box; }
      html,body{ height:100%; }
      body{
        margin:0;
        font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu, sans-serif;
        background:var(--bg);
        color:var(--text-2);
        line-height:1.7;
        text-rendering:optimizeLegibility;
      }

      a{ color:inherit; }
      img{ max-width:100%; height:auto; display:block; }

      .container{
        max-width:var(--container);
        margin:0 auto;
        padding:0 3rem;
      }
      @media (max-width: 768px){
        .container{ padding:0 1.5rem; }
      }

      /* Focus visible for keyboard users */
      :where(a,button,[role="button"], input, select, textarea):focus-visible{
        outline:none;
        box-shadow:var(--focus);
        border-radius: var(--radius-sm);
      }

      /* Skip link */
      .skip-link{
        position:absolute; left:-999px; top:auto;
        width:1px; height:1px; overflow:hidden;
      }
      .skip-link:focus{
        position:fixed; left:1rem; top:1rem; width:auto; height:auto;
        background:var(--elev-2); color:var(--text-1);
        padding:.6rem .9rem; border:1px solid var(--border-2);
        border-radius: var(--radius-sm); z-index:1000;
      }
    </style>

    <style>
      .navbar{
        background:rgba(10,10,10,.85);
        border-bottom:1px solid var(--border-2);
        padding:1rem 0;
        position:sticky; top:0; z-index:100;
        backdrop-filter: blur(10px);
      }
      .navbar .container{
        display:flex; align-items:center; justify-content:space-between;
        gap:1rem;
      }
      .logo{
        color:var(--text-1); text-decoration:none;
        letter-spacing:-.02em; font-weight:600; font-size:1.05rem;
      }
      .nav-links{ display:flex; gap:2rem; align-items:center; }
      .nav-link{
        color:var(--text-4); text-decoration:none; font-size:.95rem;
        padding:.25rem 0;
      }
      .nav-link[aria-current="page"]{ color:var(--text-1); }

      main{ min-height:calc(100vh - 200px); padding:3rem 0 5rem; }

      footer{
        border-top:1px solid var(--border-2);
        padding:2.5rem 0; text-align:center;
      }
      footer p{ color:var(--muted); font-size:.85rem; margin:.25rem 0; }
    </style>
  </head>
  <body>
    <a href="#main" class="skip-link">Skip to content</a>

    <nav class="navbar" role="navigation" aria-label="Primary">
      <div class="container">
        <a class="logo" href="/">Workspace by Ali</a>
        <div class="nav-links" role="list">
          <a class="nav-link" href={`${import.meta.env.BASE_URL}`} aria-current={Astro.url.pathname === import.meta.env.BASE_URL ? 'page' : undefined}>
            Updates
          </a>
          <a class="nav-link" href={`${import.meta.env.BASE_URL}dashboard`} aria-current={Astro.url.pathname.includes('dashboard') ? 'page' : undefined}>
            Dashboard
          </a>
        </div>
      </div>
    </nav>

<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

    <!-- Accessibility & Theming -->
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#0a0a0a" />

    <style is:global>
      :root{
        /* Core palette */
        --bg: #0a0a0a;
        --elev-1: #0f0f0f;
        --elev-2: #131313;
        --elev-3: #161616;

        --border-1:#202020;
        --border-2:#252525;
        --border-3:#353535;

        --text-1:#ffffff;
        --text-2:#e0e0e0;
        --text-3:#bbbbbb;
        --text-4:#888888;
        --text-5:#666666;
        --muted:#555555;

        --brand:#4a9eff;
        --brand-2:#6bb0ff;
        --ok:#22c55e;
        --warn:#f59e0b;
        --err:#ef4444;

        --radius-sm:6px;
        --radius-md:12px;

        --shadow-1: 0 2px 16px rgba(0,0,0,.25);
        --container: 1200px;

        --focus: 0 0 0 3px rgba(74,158,255,.45);
      }

      *{ box-sizing:border-box; }
      html,body{ height:100%; }
      body{
        margin:0;
        font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu, sans-serif;
        background:var(--bg);
        color:var(--text-2);
        line-height:1.7;
        text-rendering:optimizeLegibility;
      }

      a{ color:inherit; }
      img{ max-width:100%; height:auto; display:block; }

      .container{
        max-width:var(--container);
        margin:0 auto;
        padding:0 3rem;
      }
      @media (max-width: 768px){
        .container{ padding:0 1.5rem; }
      }

      /* Focus visible for keyboard users */
      :where(a,button,[role="button"], input, select, textarea):focus-visible{
        outline:none;
        box-shadow:var(--focus);
        border-radius: var(--radius-sm);
      }

      /* Skip link */
      .skip-link{
        position:absolute; left:-999px; top:auto;
        width:1px; height:1px; overflow:hidden;
      }
      .skip-link:focus{
        position:fixed; left:1rem; top:1rem; width:auto; height:auto;
        background:var(--elev-2); color:var(--text-1);
        padding:.6rem .9rem; border:1px solid var(--border-2);
        border-radius: var(--radius-sm); z-index:1000;
      }
    </style>

    <style>
      .navbar{
        background:rgba(10,10,10,.85);
        border-bottom:1px solid var(--border-2);
        padding:1rem 0;
        position:sticky; top:0; z-index:100;
        backdrop-filter: blur(10px);
      }
      .navbar .container{
        display:flex; align-items:center; justify-content:space-between;
        gap:1rem;
      }
      .logo{
        color:var(--text-1); text-decoration:none;
        letter-spacing:-.02em; font-weight:600; font-size:1.05rem;
      }
      .nav-links{ display:flex; gap:2rem; align-items:center; }
      .nav-link{
        color:var(--text-4); text-decoration:none; font-size:.95rem;
        padding:.25rem 0;
      }
      .nav-link[aria-current="page"]{ color:var(--text-1); }

      .user-menu {
        position: relative;
      }

      .user-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: transparent;
        border: 1px solid var(--border-2);
        border-radius: var(--radius-sm);
        padding: 0.4rem 0.75rem;
        color: var(--text-2);
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
      }

      .user-button:hover {
        background: var(--elev-2);
        border-color: var(--border-3);
      }

      .user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--brand);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
      }

      .sign-in-button {
        background: var(--brand);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s ease;
      }

      .sign-in-button:hover {
        background: var(--brand-2);
        transform: translateY(-1px);
      }

      main{ min-height:calc(100vh - 200px); padding:3rem 0 5rem; }

      footer{
        border-top:1px solid var(--border-2);
        padding:2.5rem 0; text-align:center;
      }
      footer p{ color:var(--muted); font-size:.85rem; margin:.25rem 0; }
    </style>
  </head>
  <body>
    <a href="#main" class="skip-link">Skip to content</a>

    <nav class="navbar" role="navigation" aria-label="Primary">
      <div class="container">
        <a class="logo" href="/">Workspace by Ali</a>
        <div class="nav-links" role="list">
          <a class="nav-link" href="/" aria-current={Astro.url.pathname === '/' ? 'page' : undefined}>
            Updates
          </a>
          <a class="nav-link" href="/projects" aria-current={Astro.url.pathname.includes('/projects') ? 'page' : undefined}>
            Projects
          </a>
          <a class="nav-link" href="/dashboard" aria-current={Astro.url.pathname.includes('/dashboard') ? 'page' : undefined}>
            Dashboard
          </a>

          {user ? (
            <div class="user-menu">
              <button class="user-button" id="user-menu-button">
                <div class="user-avatar">
                  {user.email?.charAt(0).toUpperCase()}
                </div>
                <span>{user.email?.split('@')[0]}</span>
              </button>
            </div>
          ) : (
            <a href="/login" class="sign-in-button">
              Sign In
            </a>
          )}
        </div>
      </div>
    </nav>

    <main id="main">
      <slot />
    </main>

    <footer role="contentinfo">
      <div class="container">
        <p>Last updated: {today.toLocaleDateString('en-AU')}</p>
        <p>Open research for ecological repair.</p>
      </div>
    </footer>

    {user && (
      <script>
        const userButton = document.getElementById('user-menu-button');
        userButton?.addEventListener('click', async () => {
          if (confirm('Sign out?')) {
            // Create a form and submit to the signout API
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/api/auth/signout';
            document.body.appendChild(form);
            form.submit();
          }
        });
      </script>
    )}
  </body>
</html>
