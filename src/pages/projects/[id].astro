---
import DashboardLayout from '../../components/layouts/DashboardLayout.astro';
import ActivityLog from '../../components/ui/ActivityLog';
import Breadcrumb from '../../components/ui/Breadcrumb';
import { createSupabaseServer } from '../../lib/supabaseServer';
import { fetchProjectFromGit, listUpdates, checkContentAccess } from '../../lib/github';
import { decryptToken } from '../../lib/tokenEncryption';
import { formatDistanceToNow } from 'date-fns';
import { Markdown } from '@astrojs/markdown-remark';

// Get project slug from URL
const { id: projectSlug } = Astro.params;

// Get user
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (!projectSlug) {
  return Astro.redirect('/projects');
}

// Fetch user's GitHub repo info
const { data: userRepo, error: repoError } = await supabase
  .from('user_repos')
  .select('repo_owner, repo_name, github_token_encrypted, user_id')
  .eq('user_id', user?.id || '')
  .single();

if (repoError || !userRepo || !userRepo.github_token_encrypted) {
  // User hasn't connected GitHub yet - redirect to onboarding
  if (!user) {
    return Astro.redirect('/login');
  }
  return Astro.redirect('/onboarding');
}

// Decrypt GitHub token
let githubToken: string;
try {
  githubToken = decryptToken(userRepo.github_token_encrypted);
} catch (error) {
  console.error('[Project Page] Token decryption failed:', error);
  return Astro.redirect('/onboarding');
}

// Fetch project from GitHub
const project = await fetchProjectFromGit(
  githubToken,
  userRepo.repo_owner,
  userRepo.repo_name,
  projectSlug
);

if (!project) {
  return Astro.redirect('/projects');
}

// Check access control
const isOwner = user?.id === userRepo.user_id;
const accessCheck = checkContentAccess(project.visibility, isOwner, false);

if (!accessCheck.allowed) {
  // TODO: Show safety modal for gated content
  return Astro.redirect('/projects');
}

// Fetch updates for this project
const updateSlugs = await listUpdates(
  githubToken,
  userRepo.repo_owner,
  userRepo.repo_name
);

// TODO: Filter updates by projectSlug and fetch their content
// For now, just show count
const totalUpdates = 0; // We'll implement this properly later

// Format dates
const createdDate = project.startDate ? new Date(project.startDate) : new Date();
const createdAgo = formatDistanceToNow(createdDate, { addSuffix: true });
---

<DashboardLayout title={`${project.title} - Workspace`}>
  <!-- Breadcrumb -->
  <Breadcrumb
    client:load
    items={[
      { label: 'Dashboard', href: '/' },
      { label: 'Projects', href: '/projects' },
      { label: project.title }
    ]}
  />

  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
    <div class="flex-1">
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-base-content">
          {project.title}
        </h1>

        <!-- Visibility badge -->
        {project.visibility === 'public' ? (
          <div class="tooltip" data-tip="Public project">
            <div class="badge badge-success gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-4 h-4">
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
              </svg>
              Public
            </div>
          </div>
        ) : (
          <div class="tooltip" data-tip="Private project">
            <div class="badge badge-ghost gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-4 h-4">
                <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              </svg>
              Private
            </div>
          </div>
        )}

        <!-- Category badge -->
        {project.category && (
          <div class="badge badge-primary badge-outline">
            {project.category}
          </div>
        )}
      </div>

      <p class="text-base-content/60 flex items-center gap-2 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-4 h-4">
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Created {createdAgo}
      </p>
    </div>

    <!-- Action buttons (only for owner) -->
    {isOwner && (
      <div class="flex gap-2">
        <a href={`/keystatic/collection/projects/item/${projectSlug}`} class="btn bg-personal-primary hover:bg-personal-primary-hover text-white border-0">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5">
            <path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" />
          </svg>
          Edit in Keystatic
        </a>
        <a href={`https://github.com/${userRepo.repo_owner}/${userRepo.repo_name}/tree/main/content/projects/${projectSlug}`} target="_blank" rel="noopener noreferrer" class="btn btn-ghost">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5">
            <path strokeLinecap="round" strokeLinejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
          </svg>
          View on GitHub
        </a>
      </div>
    )}
  </div>

  <!-- Stats -->
  <div class="stats shadow mb-8 w-full">
    <div class="stat">
      <div class="stat-title">Status</div>
      <div class="stat-value text-primary text-2xl capitalize">{project.status}</div>
      <div class="stat-desc">Project status</div>
    </div>

    <div class="stat">
      <div class="stat-title">Visibility</div>
      <div class="stat-value text-base-content text-2xl capitalize">{project.visibility}</div>
      <div class="stat-desc">{project.visibility === 'public' ? 'Anyone can view' : project.visibility === 'gated' ? 'Safety acknowledgment required' : 'Only you can see'}</div>
    </div>

    <div class="stat">
      <div class="stat-title">Category</div>
      <div class="stat-value text-base-content text-2xl capitalize">{project.category || 'None'}</div>
      <div class="stat-desc">Project type</div>
    </div>
  </div>

  <!-- Project Description -->
  {project.description && (
    <div class="card bg-base-100 shadow mb-8">
      <div class="card-body">
        <h2 class="card-title text-xl mb-3">About This Project</h2>
        <p class="text-base-content/80 whitespace-pre-wrap">{project.description}</p>
      </div>
    </div>
  )}

  <!-- Project Content (Markdown Body) -->
  {project.body && (
    <div class="card bg-base-100 shadow mb-8">
      <div class="card-body">
        <div class="prose max-w-none">
          <div set:html={project.body} />
        </div>
      </div>
    </div>
  )}

  <!-- Tags -->
  {project.tags && project.tags.length > 0 && (
    <div class="flex gap-2 mb-8 flex-wrap">
      {project.tags.map((tag) => (
        <div class="badge badge-outline">{tag}</div>
      ))}
    </div>
  )}

  <!-- Recent Updates -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title text-xl">Recent Updates</h2>
        {isOwner && (
          <a href={`/keystatic/collection/updates/create`} class="btn btn-ghost btn-sm">
            Create Update â†’
          </a>
        )}
      </div>

      {totalUpdates > 0 ? (
        <p class="text-base-content/60">Updates will be displayed here once implemented.</p>
      ) : (
        <div class="text-center py-8">
          <div class="text-base-content/40 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-12 h-12 mx-auto">
              <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
          </div>
          <p class="text-base-content/60 mb-4">No updates yet</p>
          {isOwner && (
            <a href={`/keystatic/collection/updates/create`} class="btn btn-primary btn-sm">
              Create First Update
            </a>
          )}
        </div>
      )}
    </div>
  </div>
</DashboardLayout>
