---
import DashboardLayout from '../../components/layouts/DashboardLayout.astro';
import ActivityLog from '../../components/ui/ActivityLog';
import { createSupabaseServer } from '../../lib/supabaseServer';
import { formatDistanceToNow } from 'date-fns';

// Get project ID from URL
const { id } = Astro.params;

// Get user
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

if (!id) {
  return Astro.redirect('/projects');
}

// Fetch project details
const { data: project, error: projectError } = await supabase
  .from('projects')
  .select('*')
  .eq('id', id)
  .single();

if (projectError || !project) {
  return Astro.redirect('/projects');
}

// Check if user owns this project or if it's public
if (project.owner !== user.id && project.visibility !== 'public') {
  return Astro.redirect('/projects');
}

// Fetch activities linked to this project
const { data: activities, error: activitiesError } = await supabase
  .from('activities')
  .select('*')
  .eq('project_id', id)
  .order('created_at', { ascending: false });

if (activitiesError) {
  console.error('Error fetching activities:', activitiesError);
}

// Transform activities for ActivityLog component
const activityLogData = (activities || []).map((activity) => ({
  id: activity.id,
  title: activity.title,
  description: activity.content?.substring(0, 200),
  timestamp: new Date(activity.created_at),
  type: activity.type || 'update',
}));

// Count stats
const totalActivities = activities?.length || 0;
const isOwner = project.owner === user.id;

// Format dates
const createdDate = new Date(project.created_at);
const createdAgo = formatDistanceToNow(createdDate, { addSuffix: true });
---

<DashboardLayout title={`${project.name} - Workspace`}>
  <!-- Breadcrumb -->
  <div class="text-sm breadcrumbs mb-4">
    <ul>
      <li><a href="/" class="text-base-content/60 hover:text-primary">Dashboard</a></li>
      <li><a href="/projects" class="text-base-content/60 hover:text-primary">Projects</a></li>
      <li class="text-base-content">{project.name}</li>
    </ul>
  </div>

  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
    <div class="flex-1">
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-base-content">
          {project.name}
        </h1>

        <!-- Visibility badge -->
        {project.visibility === 'public' ? (
          <div class="tooltip" data-tip="Public project">
            <div class="badge badge-success gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-4 h-4">
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
              </svg>
              Public
            </div>
          </div>
        ) : (
          <div class="tooltip" data-tip="Private project">
            <div class="badge badge-ghost gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-4 h-4">
                <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              </svg>
              Private
            </div>
          </div>
        )}

        <!-- Category badge -->
        {project.category && (
          <div class="badge badge-primary badge-outline">
            {project.category}
          </div>
        )}
      </div>

      <p class="text-base-content/60 flex items-center gap-2 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-4 h-4">
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Created {createdAgo}
      </p>
    </div>

    <!-- Action buttons (only for owner) -->
    {isOwner && (
      <div class="flex gap-2">
        <a href={`/updates/new?project=${id}`} class="btn bg-[#22c55e] hover:bg-[#16a34a] text-white border-0">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5">
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          New Update
        </a>
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="btn btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5">
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
            </svg>
          </label>
          <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
            <li><a href={`/projects/${id}/edit`}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-4 h-4">
                <path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" />
              </svg>
              Edit Project
            </a></li>
            <li><a class="text-error" onclick="if(confirm('Delete this project? This cannot be undone.')) { fetch(`/api/projects/${id}`, { method: 'DELETE' }).then(() => window.location.href='/projects'); }">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-4 h-4">
                <path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
              </svg>
              Delete Project
            </a></li>
          </ul>
        </div>
      </div>
    )}
  </div>

  <!-- Stats -->
  <div class="stats shadow mb-8 w-full">
    <div class="stat">
      <div class="stat-title">Total Updates</div>
      <div class="stat-value text-primary">{totalActivities}</div>
      <div class="stat-desc">Activity entries</div>
    </div>

    <div class="stat">
      <div class="stat-title">Visibility</div>
      <div class="stat-value text-base-content text-2xl">{project.visibility}</div>
      <div class="stat-desc">{project.visibility === 'public' ? 'Anyone can view' : 'Only you can see'}</div>
    </div>

    <div class="stat">
      <div class="stat-title">Category</div>
      <div class="stat-value text-base-content text-2xl">{project.category || 'None'}</div>
      <div class="stat-desc">Project type</div>
    </div>
  </div>

  <!-- Project Description -->
  {project.description && (
    <div class="card bg-base-100 shadow mb-8">
      <div class="card-body">
        <h2 class="card-title text-xl mb-3">About This Project</h2>
        <p class="text-base-content/80 whitespace-pre-wrap">{project.description}</p>
      </div>
    </div>
  )}

  <!-- Recent Updates -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title text-xl">Recent Updates</h2>
        {isOwner && totalActivities > 0 && (
          <a href={`/updates?project=${id}`} class="btn btn-ghost btn-sm">
            View All â†’
          </a>
        )}
      </div>

      {totalActivities > 0 ? (
        <ActivityLog client:load activities={activityLogData} limit={10} showViewAll={false} />
      ) : (
        <div class="text-center py-8">
          <div class="text-base-content/40 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-12 h-12 mx-auto">
              <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
          </div>
          <p class="text-base-content/60 mb-4">No updates yet</p>
          {isOwner && (
            <a href={`/updates/new?project=${id}`} class="btn btn-primary btn-sm">
              Create First Update
            </a>
          )}
        </div>
      )}
    </div>
  </div>
</DashboardLayout>
