---
import DashboardLayout from '../components/layouts/DashboardLayout.astro';
import StatCard from '../components/ui/StatCard';
import ActivityLog from '../components/ui/ActivityLog';
import { createSupabaseServer } from '../lib/supabaseServer';

// Get user
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Get user's first name or email
const userName = user.user_metadata?.name?.split(' ')[0] || user.email?.split('@')[0] || 'there';

// Fetch real data from database
const { data: projects } = await supabase
  .from('projects')
  .select('id')
  .eq('owner', user.id);

const { data: activities } = await supabase
  .from('activities')
  .select('*, projects(name)')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false })
  .limit(10);

const { data: streams } = await supabase
  .from('streams')
  .select('id, project_id')
  .in('project_id', (projects || []).map(p => p.id));

// Calculate stats (handle null values from failed queries)
const stats = {
  projects: projects?.length || 0,
  updates: activities?.length || 0,
  streams: streams?.length || 0,
  collaborators: 0, // TODO: Implement collaborators feature
};

// Transform activities for ActivityLog component
const recentActivities = (activities || []).slice(0, 5).map((activity) => ({
  id: activity.id,
  title: activity.title,
  description: activity.content?.substring(0, 150),
  timestamp: new Date(activity.created_at),
  type: activity.type || 'update',
}));
---

<DashboardLayout title="Dashboard - Workspace">
  <!-- Welcome Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-base-content mb-2">
      Welcome back, {userName}! ðŸ‘‹
    </h1>
    <p class="text-base-content/60">
      Here's what's happening with your workspace today.
    </p>
  </div>

  <!-- Stats Grid -->
  <div class="stats stats-vertical lg:stats-horizontal shadow w-full mb-8">
    <StatCard
      client:load
      title="Projects"
      value={stats.projects}
      description="Active research projects"
    />

    <StatCard
      client:load
      title="Updates"
      value={stats.updates}
      description="Published this month"
      trend={{ value: 20, isPositive: true }}
    />

    <StatCard
      client:load
      title="Streams"
      value={stats.streams}
      description="Active streams"
    />

    <StatCard
      client:load
      title="Collaborators"
      value={stats.collaborators}
      description="Team members"
    />
  </div>

  <!-- Grid Layout for Content -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Recent Updates (Takes 2 columns) -->
    <div class="lg:col-span-2">
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Recent Updates
          </h2>
          <ActivityLog client:load activities={recentActivities} limit={4} />
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="lg:col-span-1">
      <div class="card bg-base-100 shadow mb-6">
        <div class="card-body">
          <h2 class="card-title text-base">Quick Actions</h2>
          <div class="flex flex-col gap-2 mt-2">
            <a href="/projects/new" class="btn btn-sm bg-[#22c55e] hover:bg-[#16a34a] text-white border-0">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              New Project
            </a>
            <a href="/updates/new" class="btn btn-sm bg-[#22c55e] hover:bg-[#16a34a] text-white border-0">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z" />
              </svg>
              New Update
            </a>
            <a href="/projects" class="btn btn-ghost btn-sm">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
              </svg>
              View Projects
            </a>
          </div>
        </div>
      </div>

      <!-- Tips Card -->
      <div class="card bg-[#22c55e] text-white">
        <div class="card-body">
          <h3 class="card-title text-base">Getting Started</h3>
          <p class="text-sm opacity-90">
            Create your first project to start organizing your research and updates.
          </p>
          <div class="card-actions justify-end mt-2">
            <a href="/docs" class="btn btn-sm bg-white/20 hover:bg-white/30 text-white border-0">Learn More</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
