---
import DashboardLayout from '../components/layouts/DashboardLayout.astro';
import ThemeSettings from '../components/ui/ThemeSettings';
import ProfileSettings from '../components/ui/ProfileSettings';
import { createSupabaseServer } from '../lib/supabaseServer';

// Get user
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

const userEmail = user.email || '';

// Fetch user profile from users table
const { data: userProfile } = await supabase
  .from('users')
  .select('full_name, bio, username, is_public')
  .eq('id', user.id)
  .single();

const userName = userProfile?.full_name || user.user_metadata?.name || '';
const userBio = userProfile?.bio || '';
const username = userProfile?.username || '';
const isPublic = userProfile?.is_public || false;

// Fetch GitHub connection status
const { data: userRepo } = await supabase
  .from('user_repos')
  .select('github_token_encrypted, repo_url, repo_owner, repo_name, is_template_forked')
  .eq('user_id', user.id)
  .single();

const githubConnected = !!userRepo && !!userRepo.github_token_encrypted;
const repoForked = !!userRepo && userRepo.is_template_forked;
const repoUrl = userRepo?.repo_url || null;
---

<DashboardLayout title="Settings - Workspace">
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-base-content mb-2">
      Settings
    </h1>
    <p class="text-base-content/60">
      Manage your account and preferences
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Settings Navigation -->
    <div class="lg:col-span-1">
      <ul class="menu bg-base-100 rounded-box shadow">
        <li class="menu-title">Account</li>
        <li><a class="active">Profile</a></li>
        <li><a>Security</a></li>
        <li><a>Notifications</a></li>
        <div class="divider my-0"></div>
        <li class="menu-title">Workspace</li>
        <li><a>GitHub Integration</a></li>
        <li><a>Appearance</a></li>
        <li><a>Preferences</a></li>
      </ul>
    </div>

    <!-- Settings Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Profile Settings -->
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <h2 class="card-title mb-4">Profile Settings</h2>
          <ProfileSettings
            client:load
            userEmail={userEmail}
            initialName={userName}
            initialBio={userBio}
            initialUsername={username}
            initialIsPublic={isPublic}
          />
        </div>
      </div>

      <!-- GitHub Integration -->
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <h2 class="card-title mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
            </svg>
            GitHub Integration
          </h2>
          <p class="text-sm text-base-content/60 mb-4">
            Connect your GitHub account to enable Git-backed content storage and version control.
          </p>

          <!-- Connection Status -->
          <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg">
              <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <div>
                  <div class="font-medium">GitHub Connection</div>
                  <div class="text-sm text-base-content/60">
                    {githubConnected ? (
                      <span class="badge badge-success badge-sm">Connected</span>
                    ) : (
                      <span class="badge badge-error badge-sm">Not Connected</span>
                    )}
                  </div>
                </div>
              </div>
              {!githubConnected && (
                <a href="/api/auth/github-connect" class="btn btn-primary btn-sm">
                  Connect GitHub
                </a>
              )}
            </div>

            {githubConnected && repoForked && repoUrl && (
              <div class="space-y-3">
                <!-- Workspace Repository -->
                <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg">
                  <div class="flex items-center gap-3 flex-1 min-w-0">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
                    </svg>
                    <div class="flex-1 min-w-0">
                      <div class="font-medium">Workspace Repository</div>
                      <div class="text-sm text-base-content/60 truncate">
                        {userRepo?.repo_owner}/{userRepo?.repo_name}
                      </div>
                    </div>
                  </div>
                  <a href={repoUrl} target="_blank" rel="noopener noreferrer" class="btn btn-ghost btn-sm flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                    </svg>
                    View on GitHub
                  </a>
                </div>

                <!-- Branch Status -->
                <div class="p-4 bg-base-200 rounded-lg">
                  <div class="flex items-center gap-2 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>
                    <div class="font-medium">Branch Workflow</div>
                  </div>
                  <p class="text-sm text-base-content/60">
                    Draft branch â†’ Main branch publishing enabled
                  </p>
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                  <a href="/api/auth/github-connect" class="btn btn-outline btn-sm">
                    Reconnect GitHub
                  </a>
                  <a href="/onboarding" class="btn btn-ghost btn-sm">
                    Setup Guide
                  </a>
                </div>
              </div>
            )}

            {githubConnected && !repoForked && (
              <div class="alert alert-warning">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <div>
                  <div class="font-medium">Workspace Not Initialized</div>
                  <div class="text-sm">Complete the onboarding to create your workspace repository.</div>
                </div>
                <a href="/onboarding" class="btn btn-sm btn-warning">
                  Complete Setup
                </a>
              </div>
            )}
          </div>
        </div>
      </div>

      <!-- Appearance Settings -->
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <h2 class="card-title mb-4">Appearance</h2>
          <ThemeSettings client:load />
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="card bg-error/10 border border-error/20">
        <div class="card-body">
          <h3 class="card-title text-error">Danger Zone</h3>
          <p class="text-sm text-base-content/60 mb-4">
            Irreversible actions that affect your account
          </p>
          <button class="btn btn-error btn-outline btn-sm">
            Delete Account
          </button>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
