---
/**
 * Hash-based Auth Callback (for implicit flow)
 * This handles tokens that come in the URL fragment (#)
 */
import Layout from '../../components/Layout.astro';
---

<Layout title="Signing in..." description="Processing authentication">
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Completing sign in...</p>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';

  async function handleCallback() {
    try {
      console.log('[Hash Callback] Processing hash fragment...');

      // Get hash params
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');

      if (!accessToken) {
        console.error('[Hash Callback] No access token in hash');
        window.location.href = '/login?error=no_token';
        return;
      }

      console.log('[Hash Callback] Setting session from hash tokens...');

      // Set the session using the tokens
      const { data, error } = await supabase.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken || '',
      });

      if (error) {
        console.error('[Hash Callback] Error setting session:', error);
        window.location.href = '/login?error=session_failed';
        return;
      }

      if (data.session && data.user) {
        console.log('[Hash Callback] Session set successfully');
        console.log('[Hash Callback] User:', {
          id: data.user.id,
          email: data.user.email
        });

        // Create user profile
        const { error: upsertError } = await supabase
          .from('users')
          .upsert({
            id: data.user.id,
            email: data.user.email!,
            full_name: data.user.user_metadata?.full_name || null,
            avatar_url: data.user.user_metadata?.avatar_url || null,
            last_signin: new Date().toISOString(),
          }, {
            onConflict: 'id'
          });

        if (upsertError) {
          console.error('[Hash Callback] Error creating profile:', upsertError);
        } else {
          console.log('[Hash Callback] Profile created successfully');
        }

        // Redirect to projects
        window.location.href = '/projects';
      } else {
        console.error('[Hash Callback] No session after setting tokens');
        window.location.href = '/login?error=no_session';
      }
    } catch (err) {
      console.error('[Hash Callback] Unexpected error:', err);
      window.location.href = '/login?error=unexpected';
    }
  }

  // Run callback handler
  handleCallback();
</script>

<style>
  .loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 50vh;
    text-align: center;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--border-2);
    border-top-color: var(--brand);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1.5rem;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  p {
    color: var(--text-3);
    font-size: 1.1rem;
  }
</style>
