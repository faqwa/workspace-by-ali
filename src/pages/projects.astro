---
import DashboardLayout from '../components/layouts/DashboardLayout.astro';
import EmptyState from '../components/ui/EmptyState';
import ProjectCard from '../components/ui/ProjectCard';
import { createSupabaseServer } from '../lib/supabaseServer';

// Get user
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Fetch projects from database
const { data: projects, error: projectsError } = await supabase
  .from('projects')
  .select('*')
  .eq('owner', user.id)
  .order('created_at', { ascending: false });

if (projectsError) {
  console.error('Error fetching projects:', projectsError);
}

const publicProjects = (projects || []).filter(p => p.visibility === 'public');
const privateProjects = (projects || []).filter(p => p.visibility === 'private');
---

<DashboardLayout title="Projects - Workspace">
  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-bold text-base-content mb-2">
        Projects
      </h1>
      <p class="text-base-content/60">
        Manage your research projects and workspaces
      </p>
    </div>

    <a href="/projects/new" class="btn bg-[#22c55e] hover:bg-[#16a34a] text-white border-0">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      New Project
    </a>
  </div>

  <!-- Stats Summary -->
  <div class="stats shadow mb-8 w-full">
    <div class="stat">
      <div class="stat-title">Total Projects</div>
      <div class="stat-value text-primary">{projects?.length || 0}</div>
      <div class="stat-desc">Active workspaces</div>
    </div>

    <div class="stat">
      <div class="stat-title">Public</div>
      <div class="stat-value text-secondary">{publicProjects.length}</div>
      <div class="stat-desc">Visible to everyone</div>
    </div>

    <div class="stat">
      <div class="stat-title">Private</div>
      <div class="stat-value text-accent">{privateProjects.length}</div>
      <div class="stat-desc">Only you can see</div>
    </div>
  </div>

  <!-- Projects Grid -->
  {projects && projects.length > 0 ? (
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {projects.map((project) => (
        <ProjectCard client:load project={project} />
      ))}
    </div>
  ) : (
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <EmptyState
          client:load
          title="No projects yet"
          description="Create your first project to start organizing your research and updates."
          action={{
            label: "Create Your First Project",
            href: "/projects/new"
          }}
        />
      </div>
    </div>
  )}
</DashboardLayout>
