---
import DashboardLayout from '../../components/layouts/DashboardLayout.astro';
import Breadcrumb from '../../components/ui/Breadcrumb';
import { createSupabaseServer } from '../../lib/supabaseServer';

// Get user
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Fetch user's projects for the dropdown
const { data: userProjects } = await supabase
  .from('projects')
  .select('id, name')
  .eq('owner', user.id)
  .order('created_at', { ascending: false });
---

<DashboardLayout title="New Update - Workspace">
  <!-- Breadcrumb -->
  <Breadcrumb
    client:load
    items={[
      { label: 'Dashboard', href: '/' },
      { label: 'Updates', href: '/updates' },
      { label: 'New Update' }
    ]}
  />

  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-base-content">
      Share an Update
    </h1>
    <p class="text-base-content/60 mt-2">
      Document your progress, share insights, or log what you learned.
    </p>
  </div>

  <!-- Update Creation Form -->
  <div class="card bg-base-100 shadow max-w-3xl">
    <div class="card-body">
      <form method="POST" action="/api/updates" class="space-y-6">
        <!-- Update Title -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Update Title</span>
            <span class="label-text-alt text-error">Required</span>
          </label>
          <input
            type="text"
            name="title"
            placeholder="What did you work on or learn?"
            class="input input-bordered w-full"
            required
          />
        </div>

        <!-- Update Content -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Content</span>
            <span class="label-text-alt text-error">Required</span>
          </label>
          <textarea
            name="content"
            placeholder="Share details about your progress, insights, challenges, or learnings..."
            class="textarea textarea-bordered h-48"
            rows="8"
            required
          ></textarea>
          <label class="label">
            <span class="label-text-alt">Markdown supported</span>
          </label>
        </div>

        <!-- Link to Project -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Link to Project</span>
          </label>
          {userProjects && userProjects.length > 0 ? (
            <select name="project_id" class="select select-bordered w-full">
              <option value="">None (standalone update)</option>
              {userProjects.map((project) => (
                <option value={project.id}>{project.name}</option>
              ))}
            </select>
          ) : (
            <div class="alert">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>No projects yet. <a href="/projects/new" class="link link-primary">Create one</a> to organize your updates.</span>
            </div>
          )}
        </div>

        <!-- Hidden field for type - activities are always "update" type -->
        <input type="hidden" name="type" value="update" />

        <div class="divider"></div>

        <!-- Form Actions -->
        <div class="flex gap-3 justify-end">
          <a href="/updates" class="btn btn-ghost">Cancel</a>
          <button type="submit" class="btn bg-personal-primary hover:bg-personal-primary-hover text-white border-0">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Publish Update
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tips Card -->
  <div class="card bg-base-200 max-w-3xl mt-6">
    <div class="card-body">
      <h3 class="font-semibold flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-primary">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
        </svg>
        Why Share Updates?
      </h3>
      <ul class="text-sm space-y-2 mt-2 text-base-content/80">
        <li>• Document your learning journey for future reference</li>
        <li>• Build a portfolio of your work and progress</li>
        <li>• Get feedback from collaborators and peers</li>
        <li>• Track patterns in your work over time</li>
      </ul>
    </div>
  </div>
</DashboardLayout>
